# Plang compiler
--------
- [Overview](#Overview)
- [Build](#Build)
- [Usage](#Usage)
- [Example](#Example)


------------------

## Overview
The plang compiler is based on llvm and clang, which supports all options of clang/gcc and customerized contract options. Since plang depends on clang, you need to install clang and plang in the same path.

## Build
- install rapidjson： 
```bash 
   sudo apt-get update
   sudo apt-get install rapidjson-dev
```
- build project
```bash 
   mkdir build   
   cd build
   cmake ..
   make
```
Note: Since clang compilation requires a lot of memory, it is recommended to add one of these options in cmake.
```bash  
   -DLLVM_USE_LINKER=gold       
   -DBUILD_SHARED_LIBS=ON       
   -DCMAKE_BUILD_TYPE=Release   
```
Successful compilation will generate a plang executable file in the build/bin directory.

## Usage
```bash
    plang [clang args] [options] <inputs> <config-file>
    
    clang args:     Clang/gcc supported options
    options:        Contract compilation option
    inputs:         Input file (you can enter multiple files and will be linked)
    config-file:    Cofnig file 
```

### Contract compilation option
```bash
    -config <file>        Set the config file path
    -java-code <directoy> Set java code output directory
    -mpcc <file>          Set contract file output file
    -o <file>             Set the algorithm file output directory
    -protobuf-cc <file>   Set the path of the *.cc file generated by protobuf
    -protobuf-java <file> Set the path of the *.java file generated by protobuf
    -S                    Algorithm file output as text
```

### Config file description
```bash
    invitor            Initiator address
    parties            Participant address list
    method-price       The price of each contract function
    profit-rules       Profit distribution ratio
    urls               Participant address and port number
```

## Example
The Foo object item1 and item2 fields input by Alice are respectively subjected to absolute value operations with Bob input values, and the calculated result returns the calculated Foo object. The private contract is implemented as follows:

```cpp
#include "msg.pb.h"
#include "integer.h"

/** 
* Yao's millionaires' problem, show who is richer.
*/
Foo foo_abs(const Foo& in1, int32_t in2, const std::string& extra)
{
   Foo foo = in1;
   emp::Integer item1(in1.item1(), emp::ALICE);      //Alice's input item1
   emp::Integer item2(in1.item2(), emp::ALICE);      //Alice's input item2
   emp::Integer v2(in2, emp::BOB);                   //Bob's input 
   emp::Integer ret1 = (item1 - v2).abs();           //Privacy calculation absolute value operation
   emp::Integer ret2 = (item2 - v2).abs();           //Privacy calculation absolute value operation
   foo.set_item1(ret1.reveal_int());                 //update item1
   foo.set_item2(ret2.reveal_int());                 //update item2
   foo.set_infO(extra);

   return foo;
}
```
Save as test.cpp.

Foo protobuf definition：

```protobuf
message Foo {
    required int32 item1 = 1;
    required int32 item2 = 2;
    optional string info = 3;
}
```
Save as msg.proto.

Compile the msg.proto to generate files: msg.pb.cc, msg.pb.h and Msg.java
```shell
> protoc msg.proto --cpp_out=./ --java_out=./
```

config file as follows:
```bash
{
  "invitor": "0x60ceca9c1290ee56b98d4e160ef0453f7c40d219",
  "parties": [
    "0x60ceca9c1290ee56b98d4e160ef0453f7c40d219",
    "0x60ceca9c1290ee56b98d4e160ef0453f7c40d219"
  ],
  "method-price": {
    "foo_abs": 200
  },
  "profit-rules": {
    "0x60ceca9c1290ee56b98d4e160ef0453f7c40d219": 2
  },
  "urls": {
    "0x60ceca9c1290ee56b98d4e160ef0453f7c40d219": "DirectNodeServer:default -h 10.10.8.163 -p 10002"
  }
}
```

compile test.cpp:
```bash
./plang test.cpp -config config.json -mpcc millionaire_contract.cpp -java-code ./java -protobuf-cc msg.pb.cc -protobuf-java Msg.java
```
